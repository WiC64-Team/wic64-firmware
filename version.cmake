execute_process(COMMAND git describe --tag --dirty
    OUTPUT_VARIABLE VERSION_STRING
    ERROR_QUIET)

execute_process(COMMAND git describe --tags
    OUTPUT_VARIABLE VERSION_FROM_TAG)

string(REGEX MATCHALL [0-9]+ VERSION_AS_LIST "${VERSION_FROM_TAG}")

list(GET VERSION_AS_LIST 0 VERSION_MAJOR)
list(GET VERSION_AS_LIST 1 VERSION_MINOR)
list(GET VERSION_AS_LIST 2 VERSION_PATCH)

set(VERSION_DEVEL "0")
list(LENGTH VERSION_AS_LIST VERSION_AS_LIST_LENGTH)

if(VERSION_AS_LIST_LENGTH GREATER_EQUAL 4)
    list(GET VERSION_AS_LIST 3 VERSION_DEVEL)
endif()

string(STRIP "${VERSION_MAJOR}" VERSION_MAJOR)
string(STRIP "${VERSION_MINOR}" VERSION_MINOR)
string(STRIP "${VERSION_PATCH}" VERSION_PATCH)
string(STRIP "${VERSION_DEVEL}" VERSION_DEVEL)
string(STRIP "${VERSION_STRING}" VERSION_STRING)

string(JOIN "." VERSION_SHORT_STRING
    "${VERSION_MAJOR}"
    "${VERSION_MINOR}"
    "${VERSION_PATCH}")

if(NOT VERSION_DEVEL STREQUAL "0")
    string(CONCAT VERSION_SHORT_STRING "${VERSION_SHORT_STRING}" "-${VERSION_DEVEL}")
endif()

set(VERSION "#ifndef WIC64_GENERATED_VERSION_H
#define WIC64_GENERATED_VERSION_H

/* This file is autogenerated, do not edit */

#include <cstdint>

#define WIC64_VERSION_MAJOR ${VERSION_MAJOR}
#define WIC64_VERSION_MINOR ${VERSION_MINOR}
#define WIC64_VERSION_PATCH ${VERSION_PATCH}
#define WIC64_VERSION_DEVEL ${VERSION_DEVEL}
#define WIC64_VERSION_STRING \"${VERSION_STRING}\"
#define WIC64_VERSION_SHORT_STRING \"${VERSION_SHORT_STRING}\"

#endif // WIC64_GENERATED_VERSION_H")


if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/generated-version.h)
    file(READ ${CMAKE_CURRENT_SOURCE_DIR}/generated-version.h VERSION_)
else()
    set(VERSION_ "")
endif()

if (NOT "${VERSION}" STREQUAL "${VERSION_}")
    file(WRITE ${CMAKE_CURRENT_SOURCE_DIR}/generated-version.h "${VERSION}")
endif()